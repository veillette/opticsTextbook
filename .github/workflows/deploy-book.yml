name: MyST GitHub Pages Deploy with Multiple Exports

on:
  push:
    branches: [main]
    paths:
      - 'content/**'
      - 'scripts/**'
      - 'myst.yml'
      - 'package.json'
      - 'package-lock.json'
      - 'pwa/**'
      - 'icons/**'
      - 'img/**'
      - '.github/workflows/deploy-book.yml'
  pull_request:
    branches: [main]
    paths:
      - 'content/**'
      - 'scripts/**'
      - 'myst.yml'
      - 'package.json'
      - 'package-lock.json'
      - 'pwa/**'
      - 'icons/**'
      - 'img/**'
      - '.github/workflows/deploy-book.yml'
  workflow_dispatch:

env:
  BASE_URL: /${{ github.event.repository.name }}

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  build-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Record build start time
        run: |
          echo "BUILD_START_TIME=$(date +%s)" >> $GITHUB_ENV
          echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV
          echo "# ðŸ“Š Build Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Record checkout time
        run: |
          STEP_END_TIME=$(date +%s)
          DURATION=$((STEP_END_TIME - STEP_START_TIME))
          echo "CHECKOUT_TIME=$DURATION" >> $GITHUB_ENV
          echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Setup Pages
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: actions/configure-pages@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Record setup time
        run: |
          STEP_END_TIME=$(date +%s)
          DURATION=$((STEP_END_TIME - STEP_START_TIME))
          echo "SETUP_TIME=$DURATION" >> $GITHUB_ENV
          echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Install npm dependencies
        run: npm ci

      - name: Record npm install time
        run: |
          STEP_END_TIME=$(date +%s)
          DURATION=$((STEP_END_TIME - STEP_START_TIME))
          echo "NPM_INSTALL_TIME=$DURATION" >> $GITHUB_ENV
          echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: texlive-xetex texlive-fonts-recommended texlive-fonts-extra latexmk texlive-latex-extra imagemagick
          version: 1.0

      - name: Record LaTeX setup time
        run: |
          STEP_END_TIME=$(date +%s)
          DURATION=$((STEP_END_TIME - STEP_START_TIME))
          echo "LATEX_SETUP_TIME=$DURATION" >> $GITHUB_ENV
          echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: ./_build
          key: myst-build-${{ github.sha }}
          restore-keys: |
            myst-build-

      - name: Build PDF, DOCX, and md Assets
        run: |
          echo "Build PDF Assets, docx, and md"
          npx myst build -a
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"

      - name: Record PDF/DOCX build time
        run: |
          STEP_END_TIME=$(date +%s)
          DURATION=$((STEP_END_TIME - STEP_START_TIME))
          echo "PDF_BUILD_TIME=$DURATION" >> $GITHUB_ENV
          echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Generate PWA Icons
        run: |
          echo "Generating PWA icons"
          npm run generate-icons

      - name: Record icon generation time
        run: |
          STEP_END_TIME=$(date +%s)
          DURATION=$((STEP_END_TIME - STEP_START_TIME))
          echo "ICON_GEN_TIME=$DURATION" >> $GITHUB_ENV
          echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Build HTML Assets
        run: |
          echo "Building site with BASE_URL: $BASE_URL"
          npx myst build --html
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"

      - name: Record HTML build time
        run: |
          STEP_END_TIME=$(date +%s)
          DURATION=$((STEP_END_TIME - STEP_START_TIME))
          echo "HTML_BUILD_TIME=$DURATION" >> $GITHUB_ENV
          echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Setup PWA
        run: |
          echo "Setting up PWA (service worker, manifest, icons)"
          npm run setup-pwa

      - name: Record PWA setup time
        run: |
          STEP_END_TIME=$(date +%s)
          DURATION=$((STEP_END_TIME - STEP_START_TIME))
          echo "PWA_SETUP_TIME=$DURATION" >> $GITHUB_ENV
          echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Copy PDFs and DOCX files to _build/html for download access
        run: |
          mkdir -p _build/html/exports
          mkdir -p _build/html/exports/chapters

          # Copy full textbook PDF
          if [ -f exports/textbook.pdf ]; then
            cp exports/textbook.pdf _build/html/exports/
            echo "âœ… Full textbook PDF copied"
          else
            echo "âš ï¸ Full textbook PDF not found"
          fi

          # Copy full textbook DOCX
          if [ -f exports/textbook.docx ]; then
            cp exports/textbook.docx _build/html/exports/
            echo "âœ… Full textbook DOCX copied"
          else
            echo "âš ï¸ Full textbook DOCX not found"
          fi

          # Copy chapter PDFs
          if [ -d exports/chapters ]; then
            cp exports/chapters/*.pdf _build/html/exports/chapters/ 2>/dev/null || echo "âš ï¸ No chapter PDFs found"
            chapter_count=$(ls -1 _build/html/exports/chapters/*.pdf 2>/dev/null | wc -l)
            if [ "$chapter_count" -gt 0 ]; then
              echo "âœ… $chapter_count chapter PDFs copied"
            fi
          fi

          # Copy chapter DOCX files
          if [ -d exports/chapters ]; then
            cp exports/chapters/*.docx _build/html/exports/chapters/ 2>/dev/null || echo "âš ï¸ No chapter DOCX files found"
            docx_count=$(ls -1 _build/html/exports/chapters/*.docx 2>/dev/null | wc -l)
            if [ "$docx_count" -gt 0 ]; then
              echo "âœ… $docx_count chapter DOCX files copied"
            fi
          fi

      - name: Record file copy time
        run: |
          STEP_END_TIME=$(date +%s)
          DURATION=$((STEP_END_TIME - STEP_START_TIME))
          echo "FILE_COPY_TIME=$DURATION" >> $GITHUB_ENV
          echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Upload artifact
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_build/html'

      - name: Record upload time
        run: |
          STEP_END_TIME=$(date +%s)
          DURATION=$((STEP_END_TIME - STEP_START_TIME))
          echo "UPLOAD_TIME=$DURATION" >> $GITHUB_ENV
          echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Deploy to GitHub Pages
        id: deployment
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: actions/deploy-pages@v4

      - name: Record deployment time
        run: |
          STEP_END_TIME=$(date +%s)
          DURATION=$((STEP_END_TIME - STEP_START_TIME))
          echo "DEPLOY_TIME=$DURATION" >> $GITHUB_ENV

      - name: Build performance summary
        if: always()
        run: |
          BUILD_END_TIME=$(date +%s)
          TOTAL_TIME=$((BUILD_END_TIME - BUILD_START_TIME))

          # Convert seconds to minutes:seconds format
          format_time() {
            local seconds=$1
            local minutes=$((seconds / 60))
            local remaining_seconds=$((seconds % 60))
            printf "%dm %02ds" $minutes $remaining_seconds
          }

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â±ï¸ Build Time Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Duration | Percentage |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|------------|" >> $GITHUB_STEP_SUMMARY

          # Function to add row with percentage
          add_row() {
            local name=$1
            local time=$2
            local formatted=$(format_time $time)
            local percentage=$((time * 100 / TOTAL_TIME))
            echo "| $name | $formatted | ${percentage}% |" >> $GITHUB_STEP_SUMMARY
          }

          add_row "Checkout repository" ${CHECKOUT_TIME:-0}
          add_row "Setup (Pages + Node.js)" ${SETUP_TIME:-0}
          add_row "npm install" ${NPM_INSTALL_TIME:-0}
          add_row "LaTeX setup (APT cache)" ${LATEX_SETUP_TIME:-0}
          add_row "Build PDF/DOCX exports" ${PDF_BUILD_TIME:-0}
          add_row "Generate PWA icons" ${ICON_GEN_TIME:-0}
          add_row "Build HTML site" ${HTML_BUILD_TIME:-0}
          add_row "Setup PWA" ${PWA_SETUP_TIME:-0}
          add_row "Copy export files" ${FILE_COPY_TIME:-0}
          add_row "Upload artifact" ${UPLOAD_TIME:-0}
          add_row "Deploy to Pages" ${DEPLOY_TIME:-0}

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Total Build Time: $(format_time $TOTAL_TIME)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add performance indicators
          echo "## ðŸ“ˆ Performance Indicators" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if build is faster or slower than timeout
          TIMEOUT_SECONDS=$((20 * 60))
          USAGE_PERCENTAGE=$((TOTAL_TIME * 100 / TIMEOUT_SECONDS))

          if [ $USAGE_PERCENTAGE -lt 50 ]; then
            echo "âœ… **Excellent**: Build time is ${USAGE_PERCENTAGE}% of timeout limit" >> $GITHUB_STEP_SUMMARY
          elif [ $USAGE_PERCENTAGE -lt 75 ]; then
            echo "âœ“ **Good**: Build time is ${USAGE_PERCENTAGE}% of timeout limit" >> $GITHUB_STEP_SUMMARY
          elif [ $USAGE_PERCENTAGE -lt 90 ]; then
            echo "âš ï¸ **Warning**: Build time is ${USAGE_PERCENTAGE}% of timeout limit" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Critical**: Build time is ${USAGE_PERCENTAGE}% of timeout limit" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Top 3 slowest steps:**" >> $GITHUB_STEP_SUMMARY

          # Create sorted list of times (simple approach)
          {
            echo "${PDF_BUILD_TIME:-0} Build PDF/DOCX exports"
            echo "${HTML_BUILD_TIME:-0} Build HTML site"
            echo "${LATEX_SETUP_TIME:-0} LaTeX setup"
            echo "${NPM_INSTALL_TIME:-0} npm install"
            echo "${UPLOAD_TIME:-0} Upload artifact"
            echo "${DEPLOY_TIME:-0} Deploy to Pages"
          } | sort -rn | head -3 | while read time name; do
            if [ $time -gt 0 ]; then
              echo "- $name: $(format_time $time)" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add deployment info based on context
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ðŸ“‹ **PR Build**: Validation only (no deployment)" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸš€ Successfully deployed to https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY
          fi
