#!/bin/sh

echo ""
echo "ğŸ” Running pre-commit validation checks..."
echo ""

# Run markdown linter (shows warnings, doesn't block commit)
echo "ğŸ“ Checking markdown files..."
npm run lint:quiet || true

# Run spell check on staged markdown files (shows warnings, doesn't block)
echo "ğŸ“– Checking spelling..."
STAGED_MD=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' || true)
if [ -n "$STAGED_MD" ]; then
    echo "$STAGED_MD" | xargs npx cspell --no-progress --no-must-find-files 2>/dev/null || true
else
    echo "   No markdown files staged"
fi

# Run alt text validation on staged markdown files (shows warnings, doesn't block)
echo "ğŸ–¼ï¸  Checking image alt text..."
if [ -n "$STAGED_MD" ]; then
    echo "$STAGED_MD" | xargs node scripts/validation/validate-alt-text.js --quiet 2>/dev/null || true
fi

# Run JavaScript unit tests (must pass to commit)
echo "ğŸ§ª Running unit tests..."
npm test
TEST_EXIT=$?

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Check test results (only tests are blocking)
if [ $TEST_EXIT -ne 0 ]; then
    echo ""
    echo "âŒ Unit tests failed - commit blocked!"
    echo ""
    echo "  â€¢ Fix failing tests above"
    echo ""
    echo "ğŸ’¡ Tip: Use 'git commit --no-verify' to bypass (not recommended)"
    echo ""
    exit 1
else
    echo ""
    echo "âœ… Pre-commit checks passed!"
    echo ""
    echo "ğŸ“ Tips:"
    echo "   â€¢ Run 'npm run lint:fix' to auto-fix linting issues"
    echo "   â€¢ Run 'npm run lint:spell' for full spell check"
    echo "   â€¢ Run 'npm run lint:grammar' for grammar suggestions"
    echo ""
    exit 0
fi
